---
- name: Install Brave if non already installed 
  block:
    - name: Check if Brave is already installed
      ansible.builtin.stat:
        path: '/usr/bin/brave-browser'
      register: brave_installed

    - name: Install Brave
      ansible.builtin.shell: "curl -fsS https://dl.brave.com/install.sh | sh"
      args:
        warn: false
      when: not discord_installed.stat.exists


# Discord
- name: Check if Discord is already installed
  ansible.builtin.stat:
    path: '/usr/bin/discord'
  register: discord_installed

- name: Install Discord if non already installed 
  block:
    - name: Download Discord
      ansible.builtin.get_url:
        url: 'https://discord.com/api/download?platform=linux&format=deb'
        dest: '/tmp/discord-setup.deb'

    - name: Install Discord
      ansible.builtin.apt:
        deb: '/tmp/discord-setup.deb'
        state: present
      become: true

    - name: Delete install files
      ansible.builtin.file:
        path: '/tmp/discord-setup.deb'
        state: absent
  when: not discord_installed.stat.exists


# VSCodium
- name: Check if Codium is already installed
  ansible.builtin.stat:
    path: '/usr/bin/codium'
  register: codium_installed

- name: Install VSCodium if non already installed 
  block:
    - name: Télécharger le dernier .deb VSCodium (amd64) dans /tmp/
      ansible.builtin.shell: |
        curl -s https://api.github.com/repos/VSCodium/vscodium/releases/latest \
        | grep browser_download_url \
        | cut -d '"' -f 4 \
        | grep 'amd64.deb' \
        | wget -O /tmp/vscodium.deb -i -
      args:
        warn: false

    - name: Install Codium
      ansible.builtin.apt:
        deb: '/tmp/vscodium.deb'
        state: present
      become: true

    - name: Delete install files
      ansible.builtin.file:
        path: '/tmp/vscodium.deb'
        state: absent
  when: not codium_installed.stat.exists


# Obsidian
- name: Check if Obsidian is already installed
  ansible.builtin.stat:
    path: '/usr/bin/obsidian'
  register: obidian_installed

- name: Télécharger et installer Obsidian (dernière version .deb)
  block:
    - name: Télécharger le dernier .deb Obsidian (amd64) dans /tmp/
      ansible.builtin.shell: |
        curl -s https://api.github.com/repos/obsidianmd/obsidian-releases/releases/latest \
        | grep browser_download_url \
        | cut -d '"' -f 4 \
        | grep 'amd64.deb' \
        | wget -O /tmp/obsidian.deb -i -
      args:
        warn: false

    - name: Installer Obsidian via le .deb
      ansible.builtin.apt:
        deb: /tmp/obsidian.deb
        state: present

    - name: Supprimer le fichier /tmp/obsidian.deb après installation
      ansible.builtin.file:
        path: /tmp/obsidian.deb
        state: absent
  when: not obsidian_installed.stat.exists


# Docker
- name: Check if Docker is already installed
  ansible.builtin.stat:
    path: '/usr/bin/docker'
  register: docker_installed

- name: Configure Docker's repository
  block:
    - name: Créer le répertoire pour les clés GPG Docker
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      become: true

    - name: Télécharger la clé GPG officielle de Docker
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
      become: true

    - name: Ajouter le dépôt Docker à APT
      ansible.builtin.apt_repository:
        repo: >-
          deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.asc]
          https://download.docker.com/linux/debian
          trixie stable
        state: present
        filename: docker
        update_cache: yes
      become: true

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      become: true
  when: not docker_installed.stat.exists